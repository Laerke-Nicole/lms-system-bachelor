# Deployment Guide: Render + Railway

This guide walks you through deploying your LMS System with Render (frontend/application) and Railway (MySQL database).

## Prerequisites

- GitHub repository with your code
- Railway account (for MySQL database)
- Render account (for application hosting)

## Part 1: Set Up Railway Database

1. **Create a MySQL Database on Railway**
   - Go to [Railway](https://railway.app)
   - Click "New Project" → "Provision MySQL"
   - Note down the connection details

2. **Get Your Database Credentials**

   Railway provides these connection details:
   - `MYSQL_HOST` (e.g., `switchback.proxy.rlwy.net`)
   - `MYSQL_PORT` (e.g., `30277`)
   - `MYSQL_DATABASE` (usually `railway`)
   - `MYSQL_USER` (usually `root`)
   - `MYSQL_PASSWORD` (randomly generated)

   **Keep these handy - you'll need them for Render!**

## Part 2: Deploy to Render

### Option A: Using render.yaml (Recommended)

1. **Push to GitHub**
   ```bash
   git add .
   git commit -m "Prepare for Render deployment"
   git push origin main
   ```

2. **Create New Web Service on Render**
   - Go to [Render Dashboard](https://dashboard.render.com)
   - Click "New +" → "Web Service"
   - Connect your GitHub repository
   - Render will automatically detect `render.yaml`

3. **Configure Environment Variables**

   In the Render dashboard, add these environment variables:

   | Key | Value | Source |
   |-----|-------|--------|
   | `APP_KEY` | (auto-generated) | Render |
   | `DB_HOST` | Your Railway MySQL host | Railway |
   | `DB_PORT` | Your Railway MySQL port | Railway |
   | `DB_DATABASE` | `railway` | Railway |
   | `DB_USERNAME` | `root` | Railway |
   | `DB_PASSWORD` | Your Railway password | Railway |
   | `ADMIN1_EMAIL` | Your admin email | You choose |
   | `ADMIN1_FIRST_NAME` | Admin first name | You choose |
   | `ADMIN1_LAST_NAME` | Admin last name | You choose |
   | `ADMIN1_PHONE` | Admin phone | You choose |
   | `ADMIN1_PASSWORD` | Secure password | You choose |
   | `ADMIN2_EMAIL` | Second admin email (optional) | You choose |
   | `ADMIN2_FIRST_NAME` | Second admin first name | You choose |
   | `ADMIN2_LAST_NAME` | Second admin last name | You choose |
   | `ADMIN2_PHONE` | Second admin phone | You choose |
   | `ADMIN2_PASSWORD` | Secure password | You choose |
   | `MAIL_USERNAME` | Your Brevo login email | Brevo |
   | `MAIL_PASSWORD` | Your Brevo SMTP key | Brevo |
   | `MAIL_FROM_ADDRESS` | Sender email address | Your verified email |

   **Getting Brevo SMTP Credentials:**
   1. Log in to [Brevo](https://app.brevo.com)
   2. Go to Settings → SMTP & API
   3. Click "SMTP" tab
   4. Your SMTP credentials:
      - `MAIL_HOST`: `smtp-relay.brevo.com`
      - `MAIL_PORT`: `587`
      - `MAIL_USERNAME`: Your login email
      - `MAIL_PASSWORD`: Generate an SMTP key (starts with `xsmtpsib-`)
   5. Verify your sender email address in Brevo under "Senders"

4. **Deploy**
   - Click "Create Web Service"
   - Render will build your Docker image and deploy

### Option B: Manual Setup

1. **Create New Web Service**
   - Environment: Docker
   - Plan: Free or Starter
   - Region: Frankfurt (EU Central)

2. **Configure Build Settings**
   - Build Command: (leave empty, using Dockerfile)
   - Start Command: (leave empty, using Dockerfile)

3. **Add Environment Variables** (same as Option A table above)

4. **Deploy**

## Part 3: Verify Deployment

### Check Database Connection

Your app will automatically:
1. ✅ Run migrations on startup
2. ✅ Run production seeders (NOT factory test data)
3. ✅ Cache configurations for performance

### What Gets Seeded in Production

Only these seeders run (no fake data):
- `PostalCodeSeeder` - Real postal code
- `AddressSeeder` - Real address
- `AbInventechSeeder` - AB Inventech company
- `GdprSeeder` - GDPR settings
- `AdminUserSeeder` - Admin users
- `CourseSeeder` - Course data

**Factory-generated test data does NOT run in production!** ✅

### Access Your Application

- Your app will be available at: `https://your-app-name.onrender.com`
- First deployment takes 5-10 minutes
- Subsequent deploys are faster

## Environment Variables Reference

### Required Variables (Set in Render)

```env
# Application
APP_KEY=base64:... (generated by Render)
APP_ENV=production
APP_DEBUG=false
APP_URL=https://abi-lms.com

# Database (from Railway)
DB_CONNECTION=mysql
DB_HOST=switchback.proxy.rlwy.net
DB_PORT=30277
DB_DATABASE=railway
DB_USERNAME=root
DB_PASSWORD=your-railway-password

# Session & Cache
SESSION_DRIVER=database
CACHE_STORE=database
QUEUE_CONNECTION=database

# Logging
LOG_CHANNEL=stderr
LOG_LEVEL=error

# Admin Users (Required for seeding)
ADMIN1_EMAIL=your-admin@example.com
ADMIN1_FIRST_NAME=Admin
ADMIN1_LAST_NAME=User
ADMIN1_PHONE=12345678
ADMIN1_PASSWORD=secure-password-here

# Second Admin (Optional)
ADMIN2_EMAIL=second-admin@example.com
ADMIN2_FIRST_NAME=Second
ADMIN2_LAST_NAME=Admin
ADMIN2_PHONE=87654321
ADMIN2_PASSWORD=another-secure-password

# Mail (Brevo SMTP)
MAIL_MAILER=smtp
MAIL_HOST=smtp-relay.brevo.com
MAIL_PORT=587
MAIL_ENCRYPTION=tls
MAIL_USERNAME=your-brevo-login@example.com
MAIL_PASSWORD=xsmtpsib-your-smtp-key-here
MAIL_FROM_ADDRESS=your-verified-sender@example.com
MAIL_FROM_NAME="AB Inventech LMS"
```

## Troubleshooting

### Database Connection Issues

**Error: "SQLSTATE[HY000] [2002] Connection refused"**

✅ Check that Railway database variables are correct:
- `DB_HOST` should be Railway's MySQL host
- `DB_PORT` should be Railway's MySQL port
- `DB_PASSWORD` should match Railway's password

### Migration Issues

**Error: "Migration table not found"**

The app automatically runs migrations on startup. If they fail:
1. Check Render logs: Dashboard → Your Service → Logs
2. Verify database credentials
3. Ensure Railway database is running

### Seeder Issues

**Error: "Factory data appearing in production"**

This should NOT happen if `APP_ENV=production` is set correctly.

Verify in Render:
1. Dashboard → Your Service → Environment
2. Check `APP_ENV=production` is set
3. Redeploy if needed

### Performance Issues

**App is slow on first load**

✅ This is normal! Render free tier spins down after inactivity.
- First request wakes up the app (~30 seconds)
- Subsequent requests are fast
- Upgrade to Starter plan for always-on service

### Email/Mail Issues

**Error: Emails not being sent**

✅ Check Brevo configuration:
1. Verify environment variables in Render:
   - `MAIL_MAILER=smtp`
   - `MAIL_HOST=smtp-relay.brevo.com`
   - `MAIL_PORT=587`
   - `MAIL_ENCRYPTION=tls`
   - `MAIL_USERNAME` = your Brevo login email
   - `MAIL_PASSWORD` = your Brevo SMTP key
   - `MAIL_FROM_ADDRESS` = verified sender email
2. Verify sender email in Brevo (Settings → Senders)
3. Check Brevo SMTP quota/limits
4. Check Render logs for SMTP errors
5. After updating mail settings, redeploy or run: `php artisan config:clear`

## Updating Your Application

### Deploy New Changes

```bash
git add .
git commit -m "Your changes"
git push origin main
```

Render automatically deploys when you push to GitHub!

### Manual Deploy

In Render dashboard:
1. Go to your service
2. Click "Manual Deploy" → "Deploy latest commit"

## Security Checklist

- ✅ `APP_DEBUG=false` in production
- ✅ `APP_ENV=production` is set
- ✅ Database credentials use environment variables (not hardcoded)
- ✅ `.env` file is in `.gitignore` (never committed)
- ✅ HTTPS is enforced via `AppServiceProvider`
- ✅ Production seeders only (no factory test data)

## Cost Estimate

| Service | Plan | Cost |
|---------|------|------|
| Render Web Service | Free | $0/month |
| Railway MySQL | Hobby | ~$5/month |
| **Total** | | **~$5/month** |

**Notes:**
- Render free tier sleeps after 15 min inactivity
- Railway charges based on usage (~$5 for small apps)
- Upgrade Render to Starter ($7/mo) for production

## Support

- Render Docs: https://render.com/docs
- Railway Docs: https://docs.railway.app
- Laravel Docs: https://laravel.com/docs

## Next Steps

1. ✅ Set up custom domain (abi-lms.com)
2. ✅ Set up monitoring/alerts
3. ✅ Configure backup strategy
